---
title: ""
author: "Miles per Group (MPG): Makyra Kim, Alexander Gomez"
format: html
---

## Introduction

Our group Miles Per Group selected the dataset `mpg` from the built-in ggplot2 package in R and decided to use it for the project.

As everyday car users and seniors who will soon be purchasing their own vehicles, our group thought it would be meaningful to examine the fuel efficiency data of different cars and see what impacts the fuel efficiency of a car the most. Fuel economy has practical importance for us as soon-to-be early-career workers who are mindful of transportation costs and for understanding the environmental impact associated with different types of cars.

```{r}
data(mpg, package = "ggplot2")
??mpg
nrow(mpg)
head(mpg)
```

The dataset contains 234 observations of vehicles manufactured between 1999 and 2008 (rows), and there are 11 variables present in total: six are categorical variables (`manufacturer`, `model`, `trans`, `drv`, `fl`, and `class`) and five numeric (`displ`, `year`, `cyl`, `cty`, `hwy`).

Below is a list of all variables present in the dataset and their corresponding descriptions:

manufacturer

:   manufacturer name

model

:   model name

displ

:   engine displacement, in litres

year

:   year of manufacture

cyl

:   number of cylinders

trans

:   type of transmission

drv

:   the type of drive train, where f = front-wheel drive, r = rear wheel drive, 4 = 4wd

cty

:   city miles per gallon

hwy

:   highway miles per gallon

fl

:   fuel type

class

:   "type" of car

The **primary outcome of interest** in this analysis is the highway miles per gallon (`hwy`), a numeric variable that measures how efficiently a vehicle uses fuel during highway driving conditions.

The **predictors of interest** are engine displacement in L (`displ`), car type (`class`), and drive train type (`drv`). Possible groups for car types are 2-seater, compact, midsize, minivan, pickup, subcompact, and SUV. Possible groups for type of drive train are front-wheel drive (`f`), rear-wheel drive (`r`), and four-wheel drive (`4`).

```{r}
table(mpg$class)
```

There are 5 2-seaters, 47 compacts, 41 midsize, 11 minivans, 33 pickup trucks, 35 subcompacts, and 62 SUV vehicles.

```{r}
table(mpg$drv)
```

There are 103 four-wheel drive vehicles, 106 front-wheel drive vehicles, and 25 rear-wheel drive vehicles.

## Research Questions

**Hypothesis 1**: Vehicles with larger engines (higher `displ` value) have lower highway fuel efficiency.

-   We assume that cars with larger engines will burn more fuel.

**Hypothesis 2**: SUV and pickup trucks have lower highway MPG than compact or midsize cars.

-   We assume those bigger and heavier vehicle classes require more energy and thus less fuel economy efficiency.

**Hypothesis 3**: Front-wheel drive vehicles have higher highway MPG than four-wheel drive or rear-wheel drive vehicles.

-   We assume that for daily use, front-wheel drive, which sends power only to the front wheels, would be more efficient than four-wheel drive, which distributes power to all four wheels or rear-wheel drive, which powers the rear wheels (front wheels only steer).

## Data Exploration

```{r}
plot(mpg$displ, mpg$hwy, main = "Engine Displacement vs. Highway MPG", xlab = "Engine displacement (L)", ylab = "Highway miles per gallon", col="green")
```

Based on the scatterplot of engine displacement and highway MPG, it seems that blah blah. blah

```{r}
boxplot(hwy ~ class, data = mpg, main = "Car Type vs. Highway MPG", xlab = "Car type", ylab = "Highway miles per gallon", col = "light blue")
```

blah blah blah

```{r}
boxplot(hwy ~ drv, data = mpg, main = "Drive Train Type vs. Highway MPG", xlab = "Drive train type", ylab = "Highway miles per gallon", col = "pink")
```

blah blah

## Multiple Linear Regression Model

Now, we will fit a multiple linear regression model to predict `hwy` using `displ`, `drv`, and `class`.

```{r}
hwy_lm <- lm(hwy ~ displ + drv + class, data = mpg)
summary(hwy_lm)
```

### Interpreting estimates of slopes

Based on the summary, the reference levels are four-wheel drive (`f`) for drive train type (`drv`) and 2-seater for the car type (`class`) as they both are not present as a coefficient.

The estimated coefficient for `displ` is -2.1923. This means that for each unit (L) increase in engine displacement, `hwy` is expected to decrease by 2.1923 MPG, assuming all other variables are held constant. Since the p-value is less than 0.05, there is a meaningful relationship between the two variables.

Compared to the four-wheel drive, front-wheel drive vehicles (`drvf`) have 3.1676 higher highway MPG, assuming the other variables are held constant. There is a meaningful relationship between the two variables as the p-value is less than 0.05. On the other hand, rear-wheel drive vehicles (`drvr`) have 1.4251 higher MPG than four-wheel drive vehicles, assuming other variables are held constant, though there does not seem to be a meaningful relationship given that the p-value is greater than 0.05 (0.068).

As for the car types:

-   Compact vehicles have 5.8422 lower MPG than 2-seater vehicles, assuming other variables are held constant. Since the p-value is less than 0.05, there is a meaningful relationship between the two variables.

-   Midsize vehicles have 6.1168 lower MPG than 2-seater vehicles, assuming other variables are held constant. Since the p-value is less than 0.05, there is a meaningful relationship between the two variables.

-   Minivan vehicles have 10.2495 lower MPG than 2-seater vehicles, assuming other variables are held constant. Since the p-value is less than 0.05, there is a meaningful relationship between the two variables.

-   Pickup vehicles have 10.3147 lower MPG than 2-seater vehicles, assuming other variables are held constant. Since the p-value is less than 0.05, there is a meaningful relationship between the two variables.

-   Subcompact vehicles have 5.2616 lower MPG than 2-seater vehicles, assuming other variables are held constant. Since the p-value is less than 0.05, there is a meaningful relationship between the two variables.

-   SUV vehicles have 9.2334 lower MPG than 2-seater vehicles, assuming other variables are held constant. Since the p-value is less than 0.05, there is a meaningful relationship between the two variables.

### Interpreting R-squared

The R\^2 value is 0.8155 according to the summary. This means that the predictor variables engine displacement, drive train type, and car type, explains 81.55% of the variability in the outcome variable, `hwy`. In other words, 81.55% of the variability of highway MPG in the data can be accounted for by engine displacement, drive train type, and car type.

### Residual standard error and the accuracy of our model

From the summary, it could also be observed that the residual standard error is 2.609, meaning that the typical difference between the highway MPG predicted by the model and the actual MPG is about 2.609 miles per gallon. Given that highway MPG values in the dataset range from 12 to 44, a 2.609 miles per gallon difference is fairly small, indicating that the model predicts highway MPG with reasonable good accuracy.

```{r}
min(mpg$hwy)
max(mpg$hwy)
```

### Performing F-test

```{r}
anova(hwy_lm)
```

Null hypothesis:

$H_0: \beta_1 = \beta_2 ... = \beta_P = 0; \text{all of the regression coefficients are zero.}$

Alternative hypothesis:

$H_1: \text{At least one of the regression coefficient is non-zero.}$

Based on the results of the overall f-test, `displ` was associated with `hwy`. `drv` was associated with `hwy` after controlling `displ`. `class` was associated with `hwy` after controlling `displ` and `drv`. Since the p-values are all less than 0.05, we reject the null hypothesis that none of the three regression coefficients are useful for predicting the highway MPG, assuming we are controlling for all of the other variables. At least one of the predictor variables has a coefficient that is different from zero and is thus related to `hwy`.

## Improving the Model

Now, we will run diagnostics to ensure that none of the regression assumptions are violated. We will check for linearity, constant variance, and normality.

```{r}
library(ggfortify)

autoplot(hwy_lm)
```

### Linearity Assumption

The residual vs. fitted plot shows a systematic deviation of the residuals from 0. In some place, most of the residuals are either above the horizontal line or below the horizontal line. Residuals are mostly positive at lower fitted values and the higher fitted values, and the line displays a curve. **This indicates a failure of the linearity assumption.**

### Constant Variance Assumption

The scale-location plot shows a systematic deviation of the residuals. The plot shows an upward trend, or in other words, the standardized residuals are systematically above the line at higher fitted values. This pattern **indicates a failure of the constant variance assumption**.

### Normality Assumption

The right side of the Q-Q plot shows a systematic deviation away from the dashed line. The residuals have a longer "right tail" than would be expected if the residuals really were normal, and thus the **normality assumption is likely violated for the fuel economy dataset**.

Overall, the diagnostic plots suggest that several regression assumptions (linearity, constant variance, and normality) are violated for the fuel economy data. Given this, we will now attempt to improve the model using transformations.

### Box-cox transformation

```{r}
bc <- MASS::boxcox(hwy_lm)
```

Given that the data prefers somewhere in between $\lambda$ = 0 and $\lambda$ = $\frac{1}{2}$ in the Box-Cox plot, we will try both log and square-root transformations to compare and contrast how each transformation affects the model assumptions and overall fit.

### Log transformation

```{r}
log_lm <- lm(log(hwy) ~ displ + drv + class, data = mpg)
summary(log_lm)
autoplot(log_lm)
```

#### Linearity Assumption

In the residuals vs. fitted plot for the log-transformed model, the residuals appear more symmetrically scattered around zero, and the curved pattern has improved to be much flatter. While there still are some areas where residuals are either above the horizontal line or below the horizontal line, **the log transformation seems to have improved the linearity assumption.**

#### Constant Variance Assumption

The scale-location plot also shows a flatter, less curvy trend compared to the un-transformed model. The standardized residuals are more evenly scattered around the line and the upward trend at the right side of the plot has improved. **The constant variance assumption is improved.**

#### Normality Assumption

In the Q-Q plot, the residuals are closer to the line than in the original model, especially in the right tail. The right tail 's fit has improved greatly and the deviation has become less severe. However, the left tail bends downward more greatly than before, indicating ta slightly worse fit in the region. **Overall, the normality assumption is somewhat improved, while not entirely.**

### Square-root transformation

```{r}
sqrt_lm <- lm(sqrt(hwy) ~ displ + drv + class, data = mpg)
summary(sqrt_lm)
autoplot(sqrt_lm)
```

#### Linearity Assumption

In the residuals vs. fitted plot for the square-root-transformed model, the residuals appear more symmetrically scattered around zero, and the curved pattern has improved to be much flatter than the original model. While there still are some areas where residuals are either above the horizontal line or below the horizontal line, **the square-root transformation seems to have improved the linearity assumption.** There are **no noticeable differences in the improvement compared to the log-transformation.**

#### Constant Variance Assumption

The scale-location plot also shows a flatter, less curvy trend compared to the un-transformed model. The standardized residuals are more evenly scattered around the line and the upward trend at the right side of the plot has improved. **The constant variance assumption is improved.** However, compared to the log-transformation's, the square-root model exhibits a more noticeable and larger upward trend at the right side of the plot, **making the log-transformation more preferable when it comes to selecting**.

#### Normality Assumption

In the Q-Q plot, the residuals for the square-root model are closer to the line than in the original model, especially in the right tail. The right tail 's fit has improved greatly and the deviation has become less severe. However, the left tail bends downward more greatly than before, indicating ta slightly worse fit in the region. **Overall, the normality assumption is somewhat improved, while not entirely. Compared to the log-transformation's, the square-root transformation shows less left-tail deviation but greater right-tail deviation.**

### Splining
```{r}
library(splines)
mpg_spline <- lm(hwy ~ bs(displ, 3), data = mpg)

plot(mpg$displ, mpg$hwy)
sorted_idx <- order(mpg$displ)
lines(mpg$displ[sorted_idx], predict(mpg_spline)[sorted_idx], col = 4, lwd = 2)
# lines(mpg$displ, predict(mpg_spline), col = 4, lwd = 2)

mpg_spline <- lm(hwy ~ bs(displ, 3) + drv + class, data = mpg)
autoplot(mpg_spline)
```
After splining displacement against highway mpg, we can visually see a line that fits the data better than a linear model, but for the entire model, this may not lead to an improvment.

The model containing the spline relationship shows an improvement for normally distributed standard residuals, but the Scale-Location plot and Residuals vs. Fitted do not look any better than the original model without any splining. It is worth mentioning that that the improvements in the Normal Q-Q plot are only seen on the left side of the graph. The right still contains systematic deviations away from the line.

### Interaction
```{r}
log_interaction_lm <- lm(log(hwy) ~ displ * drv + class, data = mpg)
summary(log_interaction_lm)
```

Main Effects
- Car Class Type
- Displacement
- Drive Train Type
Interactions 
- Displacement and Drive Train Type

The interactions between displacement and drive train type are not significant. Our P-value is very large, indicating that the effects of displacement on highway mpg does not depend on drive train. There is no evidence that the interactions improve the model, as the Multiple R-squared value for the log model with interactions is the same without interactions.

```{r}
anova(log_lm, log_interaction_lm)
```
Performing anova between the model with and without the interactions, we can also see the P-value is again quite large, indicating that there is not evidence to support that the interaction terms improve the model.

## Formal Hypothesis Tests

(Your text here)




**Hypothesis 1**: Vehicles with larger engines (higher `displ` value) have lower highway fuel efficiency.

- We assume that cars with larger engines will burn more fuel.
- Null Hypothesis: Engine displacement has no effect on fuel consumption.
- Alternative Hypothesis: Engine displacement has an effect fuel consumption.
```{r}
summary(log_lm)
```
We can see that for displacement (displ), we have a non-zero slope with a significant p-value. This means we can reject our null hypothesis, and say that engine displacement does have an effect on highway mpg.

We can see that displacement does have an effect on on fuel consumption.


**Hypothesis 2**: SUV and pickup trucks have lower highway MPG than compact or midsize cars.
-   We assume those bigger and heavier vehicle classes require more energy and thus less fuel economy efficiency.
- Null Hypothesis: All types of cars have the same MPG.
- Alternative Hypothesis: At least one type of car class has a different MPG.
```{r}
hypothesis_2 <- lm(log(hwy) ~ class, data = mpg)
anova(hypothesis_2)
summary(log_lm)
```
We have evidence to support that we should reject the null hypothesis. In the anova, we can see we have a significant p-value, and when looking at the summary, each class of car has a fairly small p-value, meanining that when we control the other variables, we can expect to see difference in MPG. Relating back to our original hypothesis, we can see that SUV has the most negative slope, indicating that on average, SUVs get the worst MPG on the highway when controlling the other factors.

**Hypothesis 3**: Front-wheel drive vehicles have higher highway MPG than four-wheel drive or rear-wheel drive vehicles.
-   We assume that for daily use, front-wheel drive, which sends power only to the front wheels, would be more efficient than four-wheel drive, which distributes power to all four wheels or rear-wheel drive, which powers the rear wheels (front wheels only steer).
- Null Hypothesis: All drive trains have the same MPG.
- Alternative Hypothesis: At least one drive train type has a different MPG than the rest.
```{r}
hypothesis_3 <- lm(log(hwy) ~ drv, data = mpg)
anova(hypothesis_3)
summary(log_lm)
```
Based on the P-value from the anova (< 2.2e-16), we have decent evidence that at least one type of drive train has a different MPG on average than the rest of the drive train types.

When looking at the summary for the model, we have P-values that again support reject the null hypothesis. This evidence is not the strongest though with rear wheel drive cars having a p-value of 0.015376. Based on the slope, it looks like front wheel drive cars do get the better MPG on average than the other 2 car classes when holding the other variables constant, as drvf has the most positive slope value.

## Robustness of Results
```{r}
autoplot(log_lm)
library(car)
influencePlot(log_lm)
```
Looking at the leverage plot, we can see 44, 25, and 222, and when looking at the leverage plot, 24, 28, and 213 are influential data points.

```{r}
influential_rows <- c(24, 25, 28, 44, 213, 222)
influential_observations <- mpg[influential_rows, ]

log_lm_dfbetas <- dfbetas(log_lm)
influential_subset <- log_lm_dfbetas[influential_rows, ]
influential_subset
```
Looking at this subset, observation 25 appears to have a decent impact on intercept, displ, and all of the car class slopes. 213 nad 222 have somewhat large impacts on the drive train as well. We can use the thresh hold value to further confirm if these values are impactful to our slopes.
```{r}
N <- nrow(mpg)

threshold <- 3 / sqrt(N)
mpg[influential_rows,]

```
```{r}
subset(mpg, abs(log_lm_dfbetas[,"displ"]) > threshold)
```
```{r}
subset(mpg, abs(log_lm_dfbetas[,"drvf"]) > threshold)
```
```{r}
subset(mpg, abs(log_lm_dfbetas[,"drvr"]) > threshold)
```
```{r}
subset(mpg, abs(log_lm_dfbetas[,"classcompact"]) > threshold)
```
```{r}
subset(mpg, abs(log_lm_dfbetas[,"classmidsize"]) > threshold)
```
```{r}
subset(mpg, abs(log_lm_dfbetas[,"classminivan"]) > threshold)
```
```{r}
subset(mpg, abs(log_lm_dfbetas[,"classpickup"]) > threshold)
```
```{r}
subset(mpg, abs(log_lm_dfbetas[,"classsubcompact"]) > threshold)
```
```{r}
subset(mpg, abs(log_lm_dfbetas[,"classsuv"]) > threshold)
```

Looking at all of the subsets for the different predictors with values exceeding our threshold, the corvette models identified in the graphs also appear when looking at its influence in the slopes for the car classes.

Additionally, when looking at drive train, we also saw the beetle appear when looking at the threshold for front wheel drive.

I'm inclined to remove the Corvettes as they appeared multiple times when checking the thresholds.
```{r}
mpg_no_corvette <- mpg[-c(24, 25, 28),]
                           
mpg_lm_no_corvette <- lm(log(hwy) ~ displ + drv + class, data = mpg_no_corvette)

summary(mpg_lm_no_corvette)

summary(log_lm)
```
After removing the corvettes, all of our predictors still had a significant p-value for their slopes. We can see that the estimates had changed, but they all changes by a value between 0.01 to 0.06. In terms of miles per gallon, I do not find that to be large enough of a change to consider dropping the corvette observations from the model.

```{r}
vif(log_lm)
```
Our values are fairly close to 1. They are all between 1 and 2, meaning we likely do not have any issues with multicolinearity.

```{r}
loo_predictions <- function(fit) {
  e <- residuals(fit)
  h <- hatvalues(fit)
  Y <- fitted(fit) + e
  return(Y - e / (1 - h))
}
```

```{r}
loo_log_lm <- loo_predictions(log_lm)
cor(loo_log_lm, log(mpg$hwy))^2
```
The leave-one-out prediction error is 0.8294151 (LOO R^2)

Multiple R-squared:  0.842,	Adjusted R-squared:  0.8356 

The LOO R^2 value is 0.0125849 less than the R-squared value. Since they are quite close in value, we have strong evidence that the model is not overfit.

## Automatic Model Selection
```{r}
library(lmSubsets)
lm_all =  lm(log(hwy) ~ displ + drv + class + year + cyl + fl, data = mpg)
all_subsets <- lmSubsets(log(hwy) ~ displ + drv + class + year + fl, data = mpg)
lmSelect(all_subsets, penalty = "AIC")
```
Using subsets for the automatic model selection, the best model used formula = log(hwy) ~ displ + drv + class + year + fl. While the automatic selection said the best model used all of the variables, some of them are likely correlated or have some type of interaction that needs to be checked. For example, generally as you have more cylinders, you will have high displacement because displacement is a sum of all the volume displaced by all cylinders.


Generally, P-values become invalid after doing an automatic model selection. To get valid P-values, we would have to fit the model given on an data set that was not used.

## Conclusions

After exploring the dataset, we were quite surprised to find that the drive train was a relevant predictor for highway mpg. Our initial thought process was that we could take the same engine, and swap it into a car that was front wheel drive, rear wheel drive, and all wheel drive, and see the same fuel mpg assume everything else about the car was the same. It would be interesting to see if this was directly caused by the drive train (maybe energy from the engine is lost by having to move more wheels or going from the front of the car to the back), or if certain types of engine are used in those car types leading to the difference observed. We tried checking this with the interactions between displacement and drive train, but found no evidence of interaction.

Unsurprisingly, engines with larger displacement and SUVs tended to have a lower predicted MPG when holding the other variables constant. To us this makes sense as SUVs are larger and probably weigh more while being less aerodynamic, demanding more energy use from the engine than what a smaller car would. For displacement, we thought this made sense as well since a single rotation, a lower displacement would need less fuel to fill the cylinder volumes for combustion than one with more displacement.

***Future Research:***
I think some additional variables that would be helpful/relevent for this would be to include things like an aerodynamic rating for the cars and a binary columns for whether a vehicle has a tubro, and another for being a hybrid. I would think these are other factors that could be used to predict the highway mpg.

More generally, I think it would be interesting to research whether or not MPG has improved with newer cars or not. In the US, it feels like cars keep getting bigger/heavier, so I would expect that MPG keeps getting worse even if engine technology has improved. I would think having larger/bigger cars would lead to having to use engines that are less fuel efficent to power them, so it would be interesting to see if that is the case.
